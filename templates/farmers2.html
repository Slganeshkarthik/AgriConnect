<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgriConnect ‚Äî Farm-to-Door</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='home2.css') }}">
</head>

<body>

  <!-- Top head bar -->
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      <h1>AgriConnect</h1>
    </div>

    <form class="search" id="searchForm" onsubmit="event.preventDefault();">
      <input id="searchInput" type="search" placeholder="Search Tools, fetilizers, pesticides..." />
      <button type="submit" title="Search">Search</button>
    </form>

    <div class="actions">
      <button class="iconbtn" onclick="window.location.href='/cart.html'" title="Cart">
        üõí Cart
      </button>
      {% if user %}
      <button class="iconbtn" onclick="window.location.href='/profile.html'" title="Profile">
        üë§ <span class="username-text">{{ user.name or user.username }}</span>
      </button>
      <a class="iconbtn" href="/logout" title="Logout">‚Ü© Logout</a>
      {% else %}
      <a class="iconbtn" href="/login.html" title="Login">üë§ Login</a>
      {% endif %}
    </div>
  </header>

  <!-- Nav bar -->
  <nav class="navbar">
    <a href="/30-min.html?source=farmers">30-min</a>
    <a href="/contact.html">contact-dealer</a>
    <a href="/farmer_products.html">sell-yourself</a>
    <a
      href="https://www.farmatma.in/organic-farming/?srsltid=AfmBOoqM9pTipGXeqxFK6iTcDg4f3dfTkI8uelALI6omGAzOMWfEXV_x">tutorials</a>
    <a href="/home.html?force=true">purchase-for-home</a>
    <a href="#">IOT</a>
    <a href="/community.html">community</a>
  </nav>

  <!-- Banner -->
  <section class="banner" aria-label="Showcase">
    <div class="banner-content">
      <h2>Trusted ‚Ä¢ Authoriaed ‚Ä¢ Better-value </h2>
      <p>Connect with nearby farmers. Order directly. Fair prices, fresher produce.</p>
      <a class="cta" href="#products">Shop requirments</a>
    </div>
  </section>

  <!-- Ticker -->
  <div class="ticker-wrap" aria-label="Featured products">
    <div class="ticker" id="ticker"></div>
  </div>

  <!-- Contact strip -->
  <div class="contact">
    <span>ü§ù</span>
    <div>
      <strong>Direct connect:</strong> to a dealers .
    </div>
    <button class="btn" onclick="openDialer()">Contact a Farmer</button>
    <button class="btn secondary" onclick="startChat()">Start Chat</button>
    <button class="btn" onclick="bookSoilTest()" style="background: #8B4513; color: white;">üß™ Book Soil Test</button>
  </div>

  <!-- Main -->
  <main class="container">

    <div class="section-head">
      <h3 id="products">Products</h3>
      <div class="row">
        <button class="btn" onclick="scrollRow(-1)">‚óÄ Scroll</button>
        <button class="btn" onclick="scrollRow(1)">Scroll ‚ñ∂</button>
      </div>
    </div>

    <div class="scroller" id="scroller"></div>

    <div class="section-head">
      <h3>All Items</h3>
      <span class="meta" id="count"></span>
    </div>

    <section class="grid" id="grid"></section>

  </main>

  <!-- Customer Feedback Section -->
  <section class="feedback-section"
    style="background: linear-gradient(135deg, #faf6f0 0%, #f0e6d8 100%); padding: 50px 20px; margin-top: 30px;">
    <div class="container" style="max-width: 700px; margin: 0 auto;">
      <h3 style="text-align: center; color: #5d4037; margin-bottom: 10px; font-size: 28px;">üìù Share Your Feedback</h3>
      <p style="text-align: center; color: #666; margin-bottom: 30px;">Help us serve farmers better! Your feedback
        matters.</p>

      <form id="feedbackForm"
        style="background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
        <!-- Star Rating -->
        <div style="margin-bottom: 25px; text-align: center;">
          <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #333;">How would you rate your
            experience?</label>
          <div class="star-rating" id="starRating" style="display: inline-flex; gap: 8px; cursor: pointer;">
            <span class="star" data-rating="1" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
            <span class="star" data-rating="2" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
            <span class="star" data-rating="3" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
            <span class="star" data-rating="4" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
            <span class="star" data-rating="5" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
          </div>
          <input type="hidden" id="ratingValue" name="rating" value="0">
        </div>

        <!-- Name -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your Name</label>
          <input type="text" id="feedbackName" required placeholder="Enter your name"
            style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; box-sizing: border-box;"
            onfocus="this.style.borderColor='#8B4513'" onblur="this.style.borderColor='#e0e0e0'">
        </div>

        <!-- Email -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email Address</label>
          <input type="email" id="feedbackEmail" required placeholder="Enter your email"
            style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; box-sizing: border-box;"
            onfocus="this.style.borderColor='#8B4513'" onblur="this.style.borderColor='#e0e0e0'">
          <span id="emailError" style="color: #e53e3e; font-size: 13px; display: none; margin-top: 5px;">Please enter a
            valid email address</span>
        </div>

        <!-- Phone -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Phone Number</label>
          <input type="tel" id="feedbackPhone" required placeholder="Enter your 10-digit phone number"
            style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; box-sizing: border-box;"
            onfocus="this.style.borderColor='#8B4513'" onblur="this.style.borderColor='#e0e0e0'" maxlength="10">
          <span id="phoneError" style="color: #e53e3e; font-size: 13px; display: none; margin-top: 5px;">Please enter a
            valid 10-digit phone number</span>
        </div>

        <!-- Message -->
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your Feedback</label>
          <textarea id="feedbackMessage" required placeholder="Tell us what you think..." rows="4"
            style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; transition: border-color 0.3s; box-sizing: border-box;"
            onfocus="this.style.borderColor='#8B4513'" onblur="this.style.borderColor='#e0e0e0'"></textarea>
        </div>

        <!-- Submit Button -->
        <button type="submit"
          style="width: 100%; padding: 16px; background: linear-gradient(135deg, #8B4513, #5d4037); color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139,69,19,0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          üöÄ Submit Feedback
        </button>
      </form>
    </div>
  </section>

  <script>
    // Star Rating Functionality for Feedback
    (function () {
      const stars = document.querySelectorAll('#starRating .star');
      const ratingInput = document.getElementById('ratingValue');
      let selectedRating = 0;

      stars.forEach(star => {
        star.addEventListener('mouseenter', function () {
          const rating = this.dataset.rating;
          highlightStars(rating);
        });

        star.addEventListener('mouseleave', function () {
          highlightStars(selectedRating);
        });

        star.addEventListener('click', function () {
          selectedRating = this.dataset.rating;
          ratingInput.value = selectedRating;
          highlightStars(selectedRating);
        });
      });

      function highlightStars(rating) {
        stars.forEach(star => {
          star.style.color = star.dataset.rating <= rating ? '#FFD700' : '#ddd';
          star.style.transform = star.dataset.rating <= rating ? 'scale(1.1)' : 'scale(1)';
        });
      }

      // Phone validation using regex
      function validatePhone(phone) {
        const phoneRegex = /^[6-9]\d{9}$/;  // Indian phone: starts with 6-9, exactly 10 digits
        return phoneRegex.test(phone);
      }

      // Email validation WITHOUT regex
      function validateEmail(email) {
        // Check if email is not empty
        if (!email || email.trim() === '') return false;

        // Check if @ exists and is not at start or end
        const atIndex = email.indexOf('@');
        if (atIndex < 1 || atIndex === email.length - 1) return false;

        // Check if there's only one @
        if (email.indexOf('@', atIndex + 1) !== -1) return false;

        // Get the part after @
        const afterAt = email.substring(atIndex + 1);

        // Check if there's a dot after @ and it's not immediately after @
        const dotIndex = afterAt.indexOf('.');
        if (dotIndex < 1) return false;

        // Check if dot is not at the end
        if (dotIndex === afterAt.length - 1) return false;

        // Check if there are no spaces
        if (email.indexOf(' ') !== -1) return false;

        return true;
      }

      // Form Submission
      document.getElementById('feedbackForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const email = document.getElementById('feedbackEmail').value.trim();
        const phone = document.getElementById('feedbackPhone').value.trim();
        const emailError = document.getElementById('emailError');
        const phoneError = document.getElementById('phoneError');

        // Reset error states
        emailError.style.display = 'none';
        phoneError.style.display = 'none';
        document.getElementById('feedbackEmail').style.borderColor = '#e0e0e0';
        document.getElementById('feedbackPhone').style.borderColor = '#e0e0e0';

        // Validate email (without regex)
        if (!validateEmail(email)) {
          emailError.style.display = 'block';
          document.getElementById('feedbackEmail').style.borderColor = '#e53e3e';
          return;
        }

        // Validate phone (with regex)
        if (!validatePhone(phone)) {
          phoneError.style.display = 'block';
          document.getElementById('feedbackPhone').style.borderColor = '#e53e3e';
          return;
        }

        const formData = {
          name: document.getElementById('feedbackName').value,
          email: email,
          phone: phone,
          rating: ratingInput.value,
          message: document.getElementById('feedbackMessage').value
        };

        if (formData.rating === '0') {
          alert('Please select a rating!');
          return;
        }

        try {
          const res = await fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          const data = await res.json();
          if (data.success) {
            alert('‚úÖ Thank you for your feedback!');
            this.reset();
            selectedRating = 0;
            highlightStars(0);
          } else {
            alert('‚ùå Error: ' + (data.message || 'Could not submit feedback'));
          }
        } catch (err) {
          console.error('Feedback error:', err);
          alert('‚úÖ Thank you for your feedback!');
          this.reset();
          selectedRating = 0;
          highlightStars(0);
        }
      });
    })();
  </script>

  <footer class="container" style="opacity:.7;font-size:13px">
    <hr style="border:0;border-top:1px solid #e5e7eb;margin:24px 0">



    <!-- ====================== SCRIPT SECTION ======================= -->
    <script>

      // ---------- Utilities ----------
      const IS_LOGGED_IN = "{{ 'true' if user else 'false' }}" === "true";
      function currency(v) {
        const n = Number(v);
        return isNaN(n) ? v : new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR" }).format(n);
      }

      function openDialer() {
        const first = window.__products?.find(p => p.phone);
        if (first && first.phone) {
          window.location.href = `tel:${first.phone}`;
        } else {
          alert("No farmer phone number available.");
        }
      }

      function strtChat() {
        alert("Integrate WhatsApp or chat link here.");
      }
      function bookSoilTest() {
        if (IS_LOGGED_IN) {
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999';
          modal.innerHTML = `
      <div style="background:white;padding:30px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)">
        <h2 style="color:#8B4513;margin:0 0 20px 0;display:flex;align-items:center;gap:10px">
          üß™ Book Soil Test
        </h2>
        <form id="soilTestForm">
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#333">Farm Location/Address:</label>
            <textarea id="farmLocation" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px;font-family:inherit;resize:vertical;min-height:60px"></textarea>
          </div>
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#333">Farm Size (in acres):</label>
            <input type="number" id="farmSize" step="0.1" min="0.1" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px"/>
          </div>
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#333">Contact Number:</label>
            <input type="tel" id="contactNumber" value="{{ user.phone or '' }}" required pattern="[0-9]{10}" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px"/>
          </div>
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#333">Preferred Date:</label>
            <input type="date" id="preferredDate" required min="${new Date().toISOString().split('T')[0]}" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px"/>
          </div>
          <div style="margin-bottom:20px">
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#333">Test Type:</label>
            <select id="testType" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:14px">
              <option value="">Select Test Type</option>
              <option value="basic">Basic Soil Test - ‚Çπ500</option>
              <option value="comprehensive">Comprehensive Soil Test - ‚Çπ1200</option>
              <option value="advanced">Advanced Soil & Water Test - ‚Çπ2000</option>
            </select>
          </div>
          <div style="display:flex;gap:10px">
            <button type="submit" style="flex:1;background:#8B4513;color:white;border:none;padding:12px;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer">
              Book Now
            </button>
            <button type="button" onclick="this.closest('[style*=fixed]').remove()" style="flex:1;background:#ccc;color:#333;border:none;padding:12px;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer">
              Cancel
            </button>
          </div>
        </form>
      </div>
    `;
          document.body.appendChild(modal);

          document.getElementById('soilTestForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = {
              farm_location: document.getElementById('farmLocation').value,
              farm_size: document.getElementById('farmSize').value,
              contact_number: document.getElementById('contactNumber').value,
              preferred_date: document.getElementById('preferredDate').value,
              test_type: document.getElementById('testType').value
            };

            try {
              const res = await fetch('/api/book-soil-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });
              const data = await res.json();
              if (data.success) {
                alert('‚úÖ Soil Test Booked Successfully!\\n\\nBooking ID: ' + data.booking_id + '\\n\\nOur team will contact you within 24 hours to confirm the schedule.');
                modal.remove();
              } else {
                alert('Error: ' + data.message);
              }
            } catch (err) {
              alert('Error booking soil test. Please try again.');
              console.error(err);
            }
          });
        } else {
          alert('Please login to book a soil test.');
          window.location.href = '/login.html';
        }
      }



      // ---------- Product Cards ----------
      function productCard(p) {
        const userPincode = "{{ user.pincode if user else '' }}";
        const showFastDelivery = userPincode && p.pincode && userPincode === p.pincode;

        const div = document.createElement("article");
        div.className = "card";
        div.style.cursor = 'pointer';
        // navigate to product page when card clicked; buttons stop propagation
        div.addEventListener('click', () => { window.location.href = `/product/${p.id}`; });

        div.innerHTML = `
    <img class="thumb" src="${p.image || 'https://via.placeholder.com/600x450'}" alt="${p.name}"/>
    <div class="card-body">
      <div class="name">${p.name}</div>
      <div class="meta">by ${p.farmer} ‚Ä¢ ${p.location}</div>
      ${showFastDelivery ? '<div style="background:#0b6;color:white;padding:6px 10px;border-radius:4px;font-size:12px;font-weight:600;margin-top:6px;display:inline-block">üöÄ 30-Minute Delivery!</div>' : ''}
      <div class="row">
        ${p.new_price ?
            `<div class="price" style="text-decoration: line-through; font-weight: normal; color: #777; display: inline-block; margin-right: 5px;">${currency(p.price)}</div>
           <div class="price" style="display: inline-block;">${currency(p.new_price)}</div>`
            :
            `<div class="price">${currency(p.price)}</div>`
          }
        <div class="meta">/ ${p.unit}</div>
      </div>
      <div class="row">
        <button class="btn" onclick="event.stopPropagation(); addToCart('${p.id}')">Add to Cart</button>
      </div>
    </div>`;
        return div;
      }
      function tickerItem(p) {
        const el = document.createElement("div");
        el.className = "tick-item";
        el.innerHTML = `
    <img src="${p.image}" alt="${p.name}">
    <div>
      <strong>${p.name}</strong>
      <div class="meta">${currency(p.price)} / ${p.unit}</div>
    </div>`;
        return el;
      }

      function addToCart(id) {
        try {
          const prod = (window.__products_map && window.__products_map[id]) || (window.__products && window.__products.find(p => String(p.id) === String(id)));
          if (!prod) { alert('Product not found'); return; }

          const raw = localStorage.getItem('cart') || '[]';
          const cart = JSON.parse(raw);
          const existing = cart.find(i => String(i.id) === String(prod.id));
          if (existing) { existing.qty = (existing.qty || 1) + 1; }
          else { cart.push(Object.assign({}, prod, { qty: 1 })); }
          localStorage.setItem('cart', JSON.stringify(cart));
          alert(prod.name + ' added to cart');
        } catch (e) {
          console.error('addToCart error', e);
          alert('Could not add to cart');
        }
      }


      // ---------- Render ----------
      function render(products) {
        const grid = document.getElementById("grid");
        const scroller = document.getElementById("scroller");
        const ticker = document.getElementById("ticker");

        grid.innerHTML = "";
        scroller.innerHTML = "";
        ticker.innerHTML = "";

        products.forEach(p => {
          grid.appendChild(productCard(p));
          scroller.appendChild(productCard(p));
        });

        // Infinite smooth ticker effect
        [...products, ...products].forEach(p => ticker.appendChild(tickerItem(p)));

        document.getElementById("count").textContent = `${products.length} items`;
      }


      // ---------- Fetch Products From Backend ----------
      async function loadProducts() {
        try {
          const res = await fetch("/api/products");
          const products = await res.json();
          window.__products = products;
          // build map immediately after loading
          window.__products_map = {};
          (window.__products || []).forEach(p => { window.__products_map[p.id] = p; });
          render(products);

        } catch (err) {
          console.error("Error loading products:", err);
          alert("Unable to load products from backend.");
        }
      }

      loadProducts();

      // build global product map for quick lookups (used by addToCart)
      window.__products_map = {};
      try {
        (window.__products || []).forEach(p => { window.__products_map[p.id] = p; });
      } catch (e) { console.warn('Could not build products map', e); }


      // ---------- Search ----------
      document.getElementById("searchForm").addEventListener("submit", () => {
        const q = document.getElementById("searchInput").value.toLowerCase().trim();

        const filtered = window.__products.filter(p =>
          p.name.toLowerCase().includes(q) ||
          p.farmer.toLowerCase().includes(q) ||
          p.location.toLowerCase().includes(q)
        );

        render(filtered);
      });


      // ---------- Horizontal Scroll ----------
      const scrollerEl = () => document.getElementById("scroller");

      window.addEventListener("wheel", e => {
        const el = scrollerEl();
        if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
          el.scrollLeft += e.deltaY * 0.8;
        }
      }, { passive: true });

      function scrollRow(dir) {
        scrollerEl().scrollBy({ left: dir * 320, behavior: "smooth" });
      }

    </script>

</body>

</html>