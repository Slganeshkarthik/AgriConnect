<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Dashboard - AgriConnect</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='cart.css') }}">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-title {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
      text-align: center;
    }

    .page-title h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .page-title p {
      color: #718096;
      font-size: 16px;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      color: #718096;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
    }

    .tabs {
      display: flex;
      gap: 10px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 25px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 600;
      color: #718096;
      transition: all 0.3s;
      font-size: 15px;
    }

    .tab-btn.active {
      background: #667eea;
      color: white;
    }

    .tab-btn:hover {
      background: #e2e8f0;
    }

    .tab-btn.active:hover {
      background: #5568d3;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .content-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }

    .content-card h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #2d3748;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-block;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .product-card {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .product-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #e2e8f0;
    }

    .product-card h3 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .product-info {
      margin: 8px 0;
      color: #4a5568;
      font-size: 14px;
    }

    .product-info strong {
      color: #2d3748;
    }

    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge-warning {
      background: #feebc8;
      color: #744210;
    }

    .badge-danger {
      background: #fed7d7;
      color: #742a2a;
    }

    .badge-info {
      background: #bee3f8;
      color: #2c5282;
    }

    .notification-item {
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
      transition: all 0.3s;
    }

    .notification-item:hover {
      background: #edf2f7;
    }

    .notification-item.unread {
      background: #ebf4ff;
      border-left-color: #4299e1;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .notification-title {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .notification-time {
      color: #718096;
      font-size: 12px;
    }

    .notification-body {
      color: #4a5568;
      line-height: 1.6;
    }

    .notification-body p {
      margin: 5px 0;
    }

    .notification-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .notification-card-header button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .alert-error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #4a5568;
    }

    .empty-state p {
      font-size: 16px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .modal-header h2 {
      color: #2d3748;
      font-size: 24px;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #718096;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .close-modal:hover {
      color: #2d3748;
    }

    @media (max-width: 768px) {
      .dashboard-stats {
        grid-template-columns: 1fr;
      }

      .product-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Top head bar -->
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      <h1><span style="font-style: italic; ">AgriConnect</h1>
    </div>

    <form class="search" id="searchForm" onsubmit="event.preventDefault();">
      <input id="searchInput" type="search" placeholder="Search your products..." />
      <button type="submit" title="Search">Search</button>
    </form>

    <div class="actions">
      <button class="iconbtn" onclick="window.location.href='/farmers2.html'" title="Marketplace">
        üè™ Marketplace
      </button>
      {% if user %}
      <button class="iconbtn" onclick="window.location.href='/profile.html'" title="Profile">
        üë§ <span class="username-text">{{ user.name or user.username }}</span>
      </button>
      <a class="iconbtn" href="/logout" title="Logout">‚Ü© Logout</a>
      {% else %}
      <a class="iconbtn" href="/login.html" title="Login">üë§ Login</a>
      {% endif %}
    </div>
  </header>

  <div class="container">
    <div class="page-title">
      <h1>üåæ Farmer Dashboard</h1>
      <p>Manage your products, track orders, and grow your business</p>
    </div>

    <!-- Dashboard Statistics -->
    <div class="dashboard-stats">
      <div class="stat-card">
        <h3>Total Products</h3>
        <div class="value" id="totalProducts">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Orders</h3>
        <div class="value" id="totalOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>Pending Orders</h3>
        <div class="value" id="pendingOrders">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Earnings</h3>
        <div class="value" id="totalEarnings">‚Çπ0</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('products')">üì¶ My Products</button>
      <button class="tab-btn" onclick="switchTab('addProduct')">‚ûï Add Product</button>
      <button class="tab-btn" onclick="switchTab('notifications')">üîî Notifications <span class="badge badge-info"
          id="notifBadge" style="display:none;">0</span></button>
      <button class="tab-btn" onclick="switchTab('orders')">üìä Order History</button>
    </div>

    <!-- Products Tab -->
    <div id="productsTab" class="tab-content active">
      <div class="content-card">
        <h2>My Products</h2>
        <div id="productsContainer" class="product-grid">
          <div class="empty-state">
            <h3>Loading...</h3>
            <p>Please wait while we fetch your products </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Tab -->
    <div id="addProductTab" class="tab-content">
      <div class="content-card">
        <h2>Add New Product</h2>
        <div id="addProductAlert"></div>
        <form id="addProductForm">
          <div class="form-grid">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" name="name" required placeholder="e.g., Fresh Tomatoes">
            </div>
            <div class="form-group">
              <label>Category *</label>
              <select name="category" required>
                <option value="">Select Category</option>
                <option value="Vegetables">ü•¨ Vegetables</option>
                <option value="Fruits">üçé Fruits</option>
                <option value="Grains">üåæ Grains</option>
                <option value="Dairy">ü•õ Dairy</option>
                <option value="Pulses">ü´ò Pulses</option>
                <option value="Spices">üå∂Ô∏è Spices</option>
                <option value="Organic">üå± Organic Products</option>
                <option value="Others">üì¶ Others</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Price (‚Çπ) *</label>
              <input type="number" name="price" required min="0" step="0.01" placeholder="e.g., 50">
            </div>
            <div class="form-group">
              <label>Stock Quantity *</label>
              <input type="number" name="stock" required min="0" placeholder="e.g., 100">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Unit *</label>
              <input type="text" name="unit" required placeholder="e.g., kg, liter, dozen, piece">
            </div>
            <div class="form-group">
              <label>Image URL</label>
              <input type="url" name="image" placeholder="https://example.com/image.jpg">
            </div>
          </div>

          <div class="form-group">
            <label>Product Description</label>
            <textarea name="description" rows="4"
              placeholder="Describe your product (quality, freshness, organic certification, etc.)"></textarea>
          </div>

          <button type="submit" class="btn btn-success">‚úì Add Product</button>
        </form>
      </div>
    </div>

    <!-- Notifications Tab -->
    <div id="notificationsTab" class="tab-content">
      <div class="content-card">
        <div class="notification-card-header">
          <h2>Order Notifications</h2>
          <button id="clearNotifBtn" class="btn btn-danger btn-sm" onclick="clearNotifications()" disabled>üßπ Clear
            All</button>
        </div>
        <div id="notificationsContainer">
          <div class="empty-state">
            <h3>Loading...</h3>
            <p>Please wait while we fetch your notifications</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="ordersTab" class="tab-content">
      <div class="content-card">
        <h2>Order History & Earnings</h2>
        <div id="ordersContainer">
          <div class="empty-state">
            <h3>Loading...</h3>
            <p>Please wait while we fetch your orders</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Product</h2>
        <button class="close-modal" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editProductAlert"></div>
      <form id="editProductForm">
        <input type="hidden" id="editProductId">

        <div class="form-grid">
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="editName" required>
          </div>
          <div class="form-group">
            <label>Category *</label>
            <select id="editCategory" required>
              <option value="Vegetables">ü•¨ Vegetables</option>
              <option value="Fruits">üçé Fruits</option>
              <option value="Grains">üåæ Grains</option>
              <option value="Dairy">ü•õ Dairy</option>
              <option value="Pulses">ü´ò Pulses</option>
              <option value="Spices">üå∂Ô∏è Spices</option>
              <option value="Organic">üå± Organic Products</option>
              <option value="Others">üì¶ Others</option>
            </select>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Price (‚Çπ) *</label>
            <input type="number" id="editPrice" required min="0" step="0.01">
          </div>
          <div class="form-group">
            <label>Stock Quantity *</label>
            <input type="number" id="editStock" required min="0">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Unit *</label>
            <input type="text" id="editUnit" required>
          </div>
          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="editImage">
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="editDescription" rows="4"></textarea>
        </div>

        <button type="submit" class="btn btn-success">‚úì Update Product</button>
      </form>
    </div>
  </div>

  <script>
    let currentProducts = [];
    let currentNotifications = [];

    // Switch tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));

      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'products') loadProducts();
      else if (tabName === 'notifications') loadNotifications();
      else if (tabName === 'orders') loadOrders();
    }

    // Load farmer products
    async function loadProducts() {
      try {
        const response = await fetch('/api/farmer/products');
        const data = await response.json();

        if (data.success) {
          currentProducts = data.products;
          displayProducts(data.products);
          updateStats();
        }
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('productsContainer').innerHTML = '<div class="empty-state"><h3>Error Loading Products</h3><p>Please refresh and try again</p></div>';
      }
    }

    // Display products
    function displayProducts(products) {
      const container = document.getElementById('productsContainer');

      if (products.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Products Yet</h3><p>Start by adding your first product using the "Add Product" tab!</p></div>';
        return;
      }

      container.innerHTML = products.map(product => `
        <div class="product-card">
          ${product.image ? `<img src="${product.image}" alt="${product.name}" class="product-image">` : '<div class="product-image"></div>'}
          <h3>${product.name}</h3>
          <div class="product-info"><strong>Category:</strong> ${product.category}</div>
          <div class="product-info"><strong>Price:</strong> ‚Çπ${product.price}/${product.unit}</div>
          <div class="product-info"><strong>Stock:</strong> <span class="badge ${product.stock < 10 ? 'badge-danger' : product.stock < 50 ? 'badge-warning' : 'badge-success'}">${product.stock} </span></div>
          ${product.description ? `<div class="product-info" style="margin-top:10px;">${product.description}</div>` : ''}
          <div class="product-actions">
            <button class="btn btn-primary btn-sm" onclick="editProduct('${product.product_id}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.product_id}', '${product.name}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Add product form
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const productData = {
        name: formData.get('name'),
        category: formData.get('category'),
        price: parseFloat(formData.get('price')),
        stock: parseInt(formData.get('stock')),
        unit: formData.get('unit'),
        image: formData.get('image'),
        description: formData.get('description')
      };

      try {
        const response = await fetch('/api/farmer/add-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });

        const data = await response.json();
        const alertDiv = document.getElementById('addProductAlert');

        if (data.success) {
          alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Product added successfully!</div>';
          e.target.reset();
          loadProducts();
          setTimeout(() => {
            alertDiv.innerHTML = '';
            document.querySelector('.tab-btn').click();
          }, 2000);
        } else {
          alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${data.message}</div>`;
        }
      } catch (error) {
        document.getElementById('addProductAlert').innerHTML = '<div class="alert alert-error">‚ùå Failed to add product</div>';
      }
    });

    // Edit product
    function editProduct(productId) {
      const product = currentProducts.find(p => p.product_id === productId);
      if (!product) return;

      document.getElementById('editProductId').value = product.product_id;
      document.getElementById('editName').value = product.name;
      document.getElementById('editCategory').value = product.category;
      document.getElementById('editPrice').value = product.price;
      document.getElementById('editStock').value = product.stock;
      document.getElementById('editUnit').value = product.unit;
      document.getElementById('editImage').value = product.image || '';
      document.getElementById('editDescription').value = product.description || '';

      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      document.getElementById('editProductAlert').innerHTML = '';
    }

    // Edit product form
    document.getElementById('editProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const productId = document.getElementById('editProductId').value;
      const productData = {
        name: document.getElementById('editName').value,
        category: document.getElementById('editCategory').value,
        price: parseFloat(document.getElementById('editPrice').value),
        stock: parseInt(document.getElementById('editStock').value),
        unit: document.getElementById('editUnit').value,
        image: document.getElementById('editImage').value,
        description: document.getElementById('editDescription').value
      };

      try {
        const response = await fetch(`/api/farmer/update-product/${productId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });

        const data = await response.json();
        const alertDiv = document.getElementById('editProductAlert');

        if (data.success) {
          alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Product updated!</div>';
          loadProducts();
          setTimeout(() => closeEditModal(), 1500);
        } else {
          alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${data.message}</div>`;
        }
      } catch (error) {
        document.getElementById('editProductAlert').innerHTML = '<div class="alert alert-error">‚ùå Update failed</div>';
      }
    });

    // Delete product
    async function deleteProduct(productId, productName) {
      if (!confirm(`Delete "${productName}"?`)) return;

      try {
        const response = await fetch(`/api/farmer/delete-product/${productId}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) loadProducts();
        else alert('Error: ' + data.message);
      } catch (error) {
        alert('Failed to delete product');
      }
    }

    // Load notifications
    async function loadNotifications() {
      try {
        const response = await fetch('/api/farmer/notifications');
        const data = await response.json();

        if (data.success) {
          currentNotifications = data.notifications;
          displayNotifications(data.notifications);
          updateNotificationBadge(data.notifications);
          updateStats();
        }
      } catch (error) {
        document.getElementById('notificationsContainer').innerHTML = '<div class="empty-state"><h3>Error Loading Notifications</h3></div>';
      }
    }

    // Display notifications
    function displayNotifications(notifications) {
      const container = document.getElementById('notificationsContainer');
      const clearBtn = document.getElementById('clearNotifBtn');
      if (clearBtn) clearBtn.disabled = notifications.length === 0;

      if (notifications.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Notifications</h3><p>Order notifications will appear here</p></div>';
        return;
      }

      container.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.read_status === 0 ? 'unread' : ''}" onclick="markNotificationRead(${notif.id})">
          <div class="notification-header">
            <span class="notification-title">üõí ${notif.product_name}</span>
            <span class="notification-time">${notif.created_at}</span>
          </div>
          <div class="notification-body">
            <p><strong>Customer:</strong> ${notif.customer_name} (${notif.customer_username})</p>
            <p><strong>Quantity:</strong> ${notif.quantity} units</p>
            <p><strong>Order ID:</strong> #${notif.order_id}</p>
            <p><strong>Status:</strong> <span class="badge ${notif.status === 'completed' ? 'badge-success' :
          notif.status === 'cancelled' ? 'badge-danger' :
            notif.status === 'paid' ? 'badge-info' : 'badge-warning'
        }">${notif.status.toUpperCase()}</span></p>
          </div>
        </div>
      `).join('');
    }

    // Update notification badge
    function updateNotificationBadge(notifications) {
      const unreadCount = notifications.filter(n => n.read_status === 0).length;
      const badge = document.getElementById('notifBadge');
      badge.textContent = unreadCount;
      badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
    }

    // Mark notification as read
    async function markNotificationRead(notificationId) {
      try {
        const response = await fetch(`/api/farmer/mark-notification-read/${notificationId}`, {
          method: 'PUT'
        });
        const data = await response.json();
        if (data.success) {
          // Reload notifications to update the UI
          loadNotifications();
        }
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    async function clearNotifications() {
      if (currentNotifications.length === 0) return;
      if (!confirm('Clear all notifications?')) return;

      try {
        const response = await fetch('/api/farmer/clear-notifications', {
          method: 'DELETE'
        });
        const data = await response.json();
        if (data.success) {
          currentNotifications = [];
          displayNotifications(currentNotifications);
          updateNotificationBadge(currentNotifications);
          updateStats();
        } else {
          alert(data.message || 'Failed to clear notifications');
        }
      } catch (error) {
        alert('Failed to clear notifications');
      } finally {
        loadNotifications();
      }
    }

    // Load orders
    async function loadOrders() {
      try {
        const response = await fetch('/api/farmer/notifications');
        const data = await response.json();
        if (data.success) displayOrders(data.notifications);
      } catch (error) {
        document.getElementById('ordersContainer').innerHTML = '<div class="empty-state"><h3>Error Loading Orders</h3></div>';
      }
    }

    // Display orders
    function displayOrders(notifications) {
      const container = document.getElementById('ordersContainer');

      if (notifications.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Orders Yet</h3><p>Orders will appear here</p></div>';
        return;
      }

      const completed = notifications.filter(n => n.status === 'completed');
      const pending = notifications.filter(n => n.status === 'pending' || n.status === 'paid');
      const cancelled = notifications.filter(n => n.status === 'cancelled');

      container.innerHTML = `
        <div style="margin-bottom:30px;">
          <h3 style="color:#22543d;margin-bottom:15px;">‚úÖ Completed (${completed.length})</h3>
          ${completed.length > 0 ? completed.map(order => renderOrder(order)).join('') : '<p style="color:#718096;">No completed orders</p>'}
        </div>
        <div style="margin-bottom:30px;">
          <h3 style="color:#744210;margin-bottom:15px;">‚è≥ Pending (${pending.length})</h3>
          ${pending.length > 0 ? pending.map(order => renderOrder(order)).join('') : '<p style="color:#718096;">No pending orders</p>'}
        </div>
        <div>
          <h3 style="color:#742a2a;margin-bottom:15px;">‚ùå Cancelled (${cancelled.length})</h3>
          ${cancelled.length > 0 ? cancelled.map(order => renderOrder(order)).join('') : '<p style="color:#718096;">No cancelled orders</p>'}
        </div>
      `;
    }

    function renderOrder(order) {
      // Use stored price from notification, fallback to product lookup for old orders
      let unitPrice = order.price || 0;
      if (!unitPrice) {
        const product = currentProducts.find(p => String(p.product_id) === String(order.product_id));
        if (product) unitPrice = product.price;
      }
      const earnings = (unitPrice * order.quantity).toFixed(2);

      return `
        <div class="notification-item">
          <div class="notification-header">
            <span class="notification-title">${order.product_name}</span>
            <span class="badge ${order.status === 'completed' ? 'badge-success' :
          order.status === 'cancelled' ? 'badge-danger' :
            order.status === 'paid' ? 'badge-info' : 'badge-warning'
        }">${order.status.toUpperCase()}</span>
          </div>
          <div class="notification-body">
            <p><strong>Customer:</strong> ${order.customer_name}</p>
            <p><strong>Quantity:</strong> ${order.quantity} units</p>
            <p><strong>Earnings:</strong> <span style="color:#48bb78;font-weight:600;">‚Çπ${earnings}</span></p>
            <p><strong>Date:</strong> ${order.created_at}</p>
            <p><strong>Order ID:</strong> #${order.order_id}</p>
          </div>
        </div>
      `;
    }

    // Update stats
    function updateStats() {
      document.getElementById('totalProducts').textContent = currentProducts.length;

      const totalOrders = currentNotifications.length;
      const pendingOrders = currentNotifications.filter(n => n.status === 'pending').length;

      let totalEarnings = 0;
      // Count earnings from completed and paid orders using stored price
      currentNotifications.filter(n => n.status === 'completed' || n.status === 'paid').forEach(notif => {
        // Use the stored price from the notification (permanent record)
        // Fallback to product lookup if price is not stored (for old orders)
        let unitPrice = notif.price || 0;
        if (!unitPrice) {
          const product = currentProducts.find(p => String(p.product_id) === String(notif.product_id));
          if (product) unitPrice = product.price;
        }
        totalEarnings += unitPrice * notif.quantity;
      });

      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('pendingOrders').textContent = pendingOrders;
      document.getElementById('totalEarnings').textContent = '‚Çπ' + totalEarnings.toFixed(2);
    }

    // Initial load
    window.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      loadNotifications();
      setInterval(() => loadNotifications(), 30000);
    });
  </script>
</body>

</html>