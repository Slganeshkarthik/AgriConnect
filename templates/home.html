<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgriConnect ‚Äî Farm-to-Door</title>

  <link rel="stylesheet" href="static/home2.css">
</head>

<body>

  <!-- Top head bar -->
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      <h1>AgriConnect</h1>
    </div>

    <form class="search" id="searchForm" onsubmit="event.preventDefault();">
      <input id="searchInput" type="search" placeholder="Search Vegetable, Fruits, essentials..." />
      <button type="submit" title="Search">Search</button>
    </form>

    <div class="actions">
      <button class="iconbtn" onclick="window.location.href='/cart.html'" title="Cart">
        üõí Cart
      </button>
      {% if user %}
      <button class="iconbtn" onclick="window.location.href='/profile.html'" title="Profile">
        üë§ <span class="username-text">{{ ((user.name or user.username) or '')[0:1] }}</span>
      </button>
      <a class="iconbtn" href="/logout" title="Logout">‚Ü© Logout</a>
      {% else %}
      <a class="iconbtn" href="/login.html" title="Login">üë§ Login</a>
      {% endif %}
    </div>
  </header>

  <!-- Nav bar -->
  <nav class="navbar">
    <a href="/">Home</a>
    <a href="/30-min.html?source=home">30-min</a>
    <a href="#scheduled">Scheduled</a>
    <a href="#organic">Organic</a>
    <a href="/farmers2.html">Purchase-for-garden</a>

  </nav>

  <!-- Banner -->
  <section class="banner" aria-label="Showcase">
    <div class="banner-content">
      <h2>Fresh ‚Ä¢ Fast ‚Ä¢ Better-value </h2>
      <p>Connect with nearby farmers. Order directly. Fair prices, fresher produce.</p>
      <a class="cta" href="#products">Shop requirments</a>
    </div>
  </section>

  <!-- Ticker -->
  <div class="ticker-wrap" aria-label="Featured products">
    <div class="ticker" id="ticker"></div>
  </div>

  <!-- Contact strip -->
  <div class="contact">
    <span>ü§ù</span>
    <div>
      <strong>Direct connect:</strong> to a farmers.
    </div>
    <!--<button class="btn" onclick="openDialer()">Contact a Farmer</button>
    <button class="btn secondary" onclick="startChat()">Start Chat</button>-->
  </div>

</body>
<!-- Main -->
<main class="container">

  <div class="section-head">
    <h3 id="products">Products</h3>
    <div class="row">
      <button class="btn" onclick="scrollRow(-1)">‚óÄ Scroll</button>
      <button class="btn" onclick="scrollRow(1)">Scroll ‚ñ∂</button>
    </div>
  </div>

  <div class="scroller" id="scroller"></div>

  <div class="section-head">
    <h3>All Items</h3>
    <span class="meta" id="count"></span>
  </div>
  <!-- CATEGORY FILTER -->
  <div class="categories" id="categoryBar">
    <button class="cat-btn active" data-cat="all">All</button>
    <button class="cat-btn" data-cat="Vegetables">Vegetables</button>
    <button class="cat-btn" data-cat="Fruits">Fruits</button>
    <button class="cat-btn" data-cat="Grains">Grains</button>
    <button class="cat-btn" data-cat="Dairy">Dairy</button>
    <button class="cat-btn" data-cat="Pulses">Pulses</button>
    <button class="cat-btn" data-cat="Spices">Spices</button>
    <button class="cat-btn" data-cat="Organic">Organic Products</button>
    <button class="cat-btn" data-cat="Others">Others</button>
  </div>
  <section class="grid" id="grid"></section>

</main>

<!-- Customer Feedback Section -->
<section class="feedback-section"
  style="background: linear-gradient(135deg, #f8fdf8 0%, #e8f5e8 100%); padding: 50px 20px; margin-top: 30px;">
  <div class="container" style="max-width: 700px; margin: 0 auto;">
    <h3 style="text-align: center; color: #2d5a2d; margin-bottom: 10px; font-size: 28px;">üìù Share Your Feedback</h3>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">We value your opinion! Help us improve AgriConnect.
    </p>

    <form id="feedbackForm"
      style="background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
      <!-- Star Rating -->
      <div style="margin-bottom: 25px; text-align: center;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #333;">How would you rate your
          experience?</label>
        <div class="star-rating" id="starRating" style="display: inline-flex; gap: 8px; cursor: pointer;">
          <span class="star" data-rating="1" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
          <span class="star" data-rating="2" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
          <span class="star" data-rating="3" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
          <span class="star" data-rating="4" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
          <span class="star" data-rating="5" style="font-size: 32px; color: #ddd; transition: all 0.2s;">‚òÖ</span>
        </div>
        <input type="hidden" id="ratingValue" name="rating" value="0">
      </div>

      <!-- Name -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your Name</label>
        <input type="text" id="feedbackName" required placeholder="Enter your name"
          style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; box-sizing: border-box;"
          onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#e0e0e0'">
      </div>

      <!-- Email -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email Address</label>
        <input type="email" id="feedbackEmail" required placeholder="Enter your email"
          style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; box-sizing: border-box;"
          onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#e0e0e0'">
      </div>

      <!-- Message -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your Feedback</label>
        <textarea id="feedbackMessage" required placeholder="Tell us what you think..." rows="4"
          style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; transition: border-color 0.3s; box-sizing: border-box;"
          onfocus="this.style.borderColor='#4CAF50'" onblur="this.style.borderColor='#e0e0e0'"></textarea>
      </div>

      <!-- Submit & Clear Actions -->
      <div style="display: flex; flex-wrap: wrap; gap: 12px;">
        <button type="submit"
          style="flex: 1 1 240px; padding: 16px; background: linear-gradient(135deg, #4CAF50, #2d7a2d); color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76,175,80,0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          üöÄ Submit Feedback
        </button>
        <button type="button" onclick="clearForm()"
          style="flex: 1 1 180px; padding: 16px; background: red; color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; align-self: flex-end;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76,175,80,0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          Clear Form
        </button>
      </div>
    </form>
    <p id="msg"></p>
  </div>
  <script>
    function clearForm() {
      document.getElementById("feedbackForm").reset();
      document.getElementById("msg").innerText = "Thank you! Form cleared.";
    }

  </script>
</section>

<script>
  // Star Rating Functionality
  (function () {
    const stars = document.querySelectorAll('#starRating .star');
    const ratingInput = document.getElementById('ratingValue');
    let selectedRating = 0;

    stars.forEach(star => {
      star.addEventListener('mouseenter', function () {
        const rating = this.dataset.rating;
        highlightStars(rating);
      });

      star.addEventListener('mouseleave', function () {
        highlightStars(selectedRating);
      });

      star.addEventListener('click', function () {
        selectedRating = this.dataset.rating;
        ratingInput.value = selectedRating;
        highlightStars(selectedRating);
      });
    });

    function highlightStars(rating) {
      stars.forEach(star => {
        star.style.color = star.dataset.rating <= rating ? '#FFD700' : '#ddd';
        star.style.transform = star.dataset.rating <= rating ? 'scale(1.1)' : 'scale(1)';
      });
    }

    // Form Submission
    document.getElementById('feedbackForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = {
        name: document.getElementById('feedbackName').value,
        email: document.getElementById('feedbackEmail').value,
        rating: ratingInput.value,
        message: document.getElementById('feedbackMessage').value
      };



      if (formData.rating === '0') {
        alert('Please select a rating!');
        return;
      }

      try {
        const res = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await res.json();
        if (data.success) {
          alert('‚úÖ Thank you for your feedback!');
          this.reset();
          selectedRating = 0;
          highlightStars(0);
        } else {
          alert('‚ùå Error: ' + (data.message || 'Could not submit feedback'));
        }
      } catch (err) {
        console.error('Feedback error:', err);
        alert('‚úÖ Thank you for your feedback!');
        this.reset();
        selectedRating = 0;
        highlightStars(0);
      }
    });
  })();
</script>

<footer class="container" style="opacity:.7;font-size:13px">
  <hr style="border:0;border-top:1px solid #e5e7eb;margin:24px 0">
</footer>


<!-- ====================== SCRIPT SECTION ======================= -->
<script type="application/json" id="__products-data">{{ products|tojson | safe }}</script>
<script>

  // Inject server-passed products from Flask
  window.__products = JSON.parse(document.getElementById('__products-data').textContent || '[]');


  // ---------- Utilities ----------
  function currency(v) {
    const n = Number(v);
    return isNaN(n) ? v : new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR" }).format(n);
  }



  function startChat() {
    alert("Integrate WhatsApp or chat link here.");
  }


  // ---------- Product Cards ----------
  function productCard(p) {
    const producerName = p.farmer || p.seller || p.seller_name || p.seller_username || "Local farm";
    const originLabel = p.location || p.origin || "Nearby farmer";
    const div = document.createElement("article");
    div.className = "card";
    div.style.cursor = 'pointer';
    // navigate to product page when card clicked; buttons stop propagation
    div.addEventListener('click', () => { window.location.href = `/product/${p.id}`; });

    div.innerHTML = `
    <img class="thumb" src="${p.image || 'https://via.placeholder.com/600x450'}" alt="${p.name}"/>
    <div class="card-body">
      <div class="name">${p.name}</div>
      <div class="meta">by ${producerName} ‚Ä¢ ${originLabel}</div>
      <div class="row">
        <!-- <span class="price"><strong>${currency(p.price)}</strong></span> -->
        <!-- <div class="price" style="text-decoration: line-through; font-weight: normal;" >${currency(p.price)}</div>-->
        <!-- <span class="new-price"><strong>${currency(p.price / 2)}</strong></span>-->
        ${p.new_price ?
        `<div class="price" style="text-decoration: line-through; font-weight: normal; color: #777; margin-right: 5px;" >${currency(p.price)}</div>
           <span class="new-price"><strong>${currency(p.new_price)}</strong></span>`
        :
        `<span class="price"><strong>${currency(p.price)}</strong></span>`
      }
        <div class="meta">/ ${p.unit}</div>

      </div>
      
      <div class="row">
        <button class="btn" onclick="event.stopPropagation(); addToCart('${p.id}')">Add to Cart</button>
      </div>
    </div>`;
    return div;
  }

  function tickerItem(p) {
    const el = document.createElement("div");
    el.className = "tick-item";
    el.innerHTML = `
    <img src="${p.image}" alt="${p.name}">
    <div>
      <strong>${p.name}</strong>
      <div class="meta">${currency(p.price)} / ${p.unit}</div>
    </div>`;
    return el;
  }

  function addToCart(id) {
    try {
      const prod = (window.__products_map && window.__products_map[id]) || (window.__products && window.__products.find(p => String(p.id) === String(id)));
      if (!prod) { alert('Product not found'); return; }

      const raw = localStorage.getItem('cart') || '[]';
      const cart = JSON.parse(raw);
      const existing = cart.find(i => String(i.id) === String(prod.id));
      if (existing) { existing.qty = (existing.qty || 1) + 1; }
      else { cart.push(Object.assign({}, prod, { qty: 1 })); }
      localStorage.setItem('cart', JSON.stringify(cart));
      alert(prod.name + ' added to cart');
    } catch (e) {
      console.error('addToCart error', e);
      alert('Could not add to cart');
    }
  }


  // ---------- Render ----------
  function render(products) {
    const grid = document.getElementById("grid");
    const scroller = document.getElementById("scroller");
    const ticker = document.getElementById("ticker");

    grid.innerHTML = "";
    scroller.innerHTML = "";
    ticker.innerHTML = "";

    if (!products.length) {
      grid.innerHTML = '<div class="empty-state">No products available</div>';
      document.getElementById("count").textContent = "0 items";
      return;
    }

    products.forEach(p => {
      grid.appendChild(productCard(p));
      scroller.appendChild(productCard(p));
    });

    // Infinite smooth ticker effect
    [...products, ...products].forEach(p => ticker.appendChild(tickerItem(p)));

    document.getElementById("count").textContent = `${products.length} items`;
  }


  // ---------- Fetch Products From Backend ----------
  async function loadProducts() {
    try {
      // If products are already available from the server, use them instead of fetching.
      if (window.__products && window.__products.length) {
        render(window.__products);
        return;
      }

    } catch (err) {
      console.error("Error loading products:", err);
      alert("Unable to load products from backend.");
    }
  }

  loadProducts();

  // build global product map for quick lookups (used by addToCart)
  window.__products_map = {};
  try {
    (window.__products || []).forEach(p => { window.__products_map[p.id] = p; });
  } catch (e) { console.warn('Could not build products map', e); }


  // ---------- Search ----------
  document.getElementById("searchForm").addEventListener("submit", () => {
    const q = document.getElementById("searchInput").value.toLowerCase().trim();

    const filtered = window.__products.filter(p =>
      p.name.toLowerCase().includes(q) ||
      p.farmer.toLowerCase().includes(q) ||
      p.location.toLowerCase().includes(q)
    );

    render(filtered);
  });


  // ---------- Horizontal Scroll ----------
  const scrollerEl = () => document.getElementById("scroller");

  window.addEventListener("wheel", e => {
    const el = scrollerEl();
    if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
      el.scrollLeft += e.deltaY * 0.8;
    }
  }, { passive: true });

  function scrollRow(dir) {
    scrollerEl().scrollBy({ left: dir * 320, behavior: "smooth" });
  }
  // CATEGORY FILTER
  document.getElementById("categoryBar").addEventListener("click", (e) => {
    if (!e.target.classList.contains("cat-btn")) return;

    // Active button highlight
    document.querySelectorAll(".cat-btn").forEach(btn => btn.classList.remove("active"));
    e.target.classList.add("active");

    const cat = e.target.dataset.cat;

    if (cat === "all") {
      render(window.__products);
      return;
    }

    // Normalize to handle singular/plural mismatches
    const norm = (cat || '').toLowerCase().replace(/s$/, '');
    const filtered = window.__products.filter(p => ((p.category || '').toLowerCase().replace(/s$/, '') === norm));
    render(filtered);
  });

</script>

</body>
