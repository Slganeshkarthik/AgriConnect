<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ product.name if product else 'Product' }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='home2.css') }}">
  <style>
    body { overflow-x: hidden; }
    .product-page { max-width:900px;margin:28px auto;padding:18px }
    .product-top { display:flex;gap:18px;align-items:flex-start }
    .product-top img{ width:360px; height:auto; object-fit:cover; border-radius:6px }
    .product-meta { flex:1; min-width:0 }
    .price { font-size:22px;font-weight:700;color:#0b6 }
    .meta { color:#666;margin-top:6px }
    .actions .btn{ margin-right:8px }
    
    .rating-display { display:flex; align-items:center; gap:10px; margin:10px 0 }
    .stars { color:#f4b400; font-size:20px; letter-spacing:2px }
    .rating-info { color:#666; font-size:14px }
    
    .rating-section { margin-top:30px; padding-top:20px; border-top:1px solid #e5e7eb }
    .rating-form { background:#f9fafb; padding:16px; border-radius:8px; margin:16px 0 }
    .star-rating { display:flex; gap:8px; font-size:32px; cursor:pointer }
    .star-rating span { color:#d1d5db; transition:color 0.2s }
    .star-rating span:hover,
    .star-rating span.active { color:#f4b400 }
    
    .reviews { margin-top:20px }
    .review-card { background:#fff; padding:14px; border-radius:8px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08) }
    .review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .review-user { font-weight:600; color:#333 }
    .review-date { color:#999; font-size:12px }
    .review-stars { color:#f4b400; font-size:16px }
    .review-comment { color:#555; line-height:1.5 }
    
    textarea { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-family:inherit; resize:vertical }
    
    @media (max-width: 768px) {
      .product-page { 
        padding: 12px;
        margin: 16px 10px;
      }
      .product-top { 
        flex-direction: column;
        gap: 16px;
      }
      .product-top img { 
        width: 100%;
        max-width: 100%;
      }
      .product-meta h1 {
        font-size: 22px;
      }
      .price {
        font-size: 20px;
      }
    }
    
    @media (max-width: 520px) {
      .product-page {
        padding: 10px;
        margin: 12px 8px;
      }
      .product-top {
        gap: 12px;
      }
      .product-meta h1 {
        font-size: 20px;
        word-wrap: break-word;
      }
      .price {
        font-size: 18px;
      }
      .actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .actions .btn {
        margin-right: 0;
        width: 100%;
      }
      .meta {
        font-size: 14px;
      }
      .stars {
        font-size: 18px;
      }
      .star-rating {
        font-size: 28px;
      }
      .review-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }
  </style>
</head>
<body>
  <main class="product-page">
    <a href="{{ url_for('home') }}">‚Üê Back to products</a>

    {% if not product %}
      <h2>Product not found</h2>
      <p>The product you requested could not be found.</p>
    {% else %}
      <div class="product-top">
        <img src="{{ product.image }}" alt="{{ product.name }}">
        <div class="product-meta">
          <h1>{{ product.name }}</h1>
          {% if product.farmer %}
            <div class="meta">by {{ product.farmer }}{% if product.location %} ‚Ä¢ {{ product.location }}{% endif %}</div>
          {% endif %}
          
          <!-- Rating Display -->
          <div class="rating-display">
            <span class="stars">{% for i in range(1, 6) %}{% if i <= avg_rating|round|int %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</span>
            <span class="rating-info">{{ avg_rating }} ({{ total_ratings }} {% if total_ratings == 1 %}review{% else %}reviews{% endif %})</span>
          </div>
          
          <div class="price">‚Çπ{{ product.price | int }} INR</div>
          <div class="meta">Unit: {{ product.unit }}</div>
          {% if user and user.pincode and product.pincode and user.pincode == product.pincode %}
            <div style="background:#0b6;color:white;padding:8px 12px;border-radius:4px;display:inline-block;margin-top:8px;font-weight:600">
              üöÄ 30-Minute Delivery Available!
            </div>
          {% endif %}
          {% if product.category %}
            <div class="meta">Category: {{ product.category }}</div>
          {% endif %}

          <div style="margin-top:14px" class="actions">
            <button class="btn" onclick="addToCart('{{ product.id }}')">Add to Cart</button>
            {% if product.phone %}
              <a class="btn secondary" href="tel:{{ product.phone }}">Contact Seller</a>
            {% endif %}
          </div>

          {% if product.farmer or product.location or product.phone %}
          <div style="margin-top:18px" class="details">
            <h3>Details</h3>
            {% if product.farmer %}
              <p><strong>Seller:</strong> {{ product.farmer }}</p>
            {% endif %}
            {% if product.location %}
              <p><strong>Location:</strong> {{ product.location }}</p>
            {% endif %}
            {% if product.phone %}
              <p><strong>Phone:</strong> {{ product.phone }}</p>
            {% endif %}
            {% if product.Rating %}
              <p><strong>Rating:</strong> {{ product.Rating }}</p>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Rating Section -->
      <div class="rating-section">
        <h3>Customer Reviews</h3>
        
        {% if user and has_purchased %}
          <div class="rating-form">
            <h4>{% if user_rating %}Update Your Review{% else %}Write a Review{% endif %}</h4>
            <p style="color:#666;font-size:14px">You purchased this product. Share your experience!</p>
            
            <div class="star-rating" id="starRating">
              <span data-value="1">‚òÖ</span>
              <span data-value="2">‚òÖ</span>
              <span data-value="3">‚òÖ</span>
              <span data-value="4">‚òÖ</span>
              <span data-value="5">‚òÖ</span>
            </div>
            <input type="hidden" id="ratingValue" value="{{ user_rating.rating if user_rating else 0 }}">
            
            <div style="margin-top:12px">
              <textarea id="commentText" rows="4" placeholder="Share details about your experience (optional)">{{ user_rating.comment if user_rating else '' }}</textarea>
            </div>
            
            <button class="btn" onclick="submitRating()" style="margin-top:10px">Submit Review</button>
          </div>
        {% elif user %}
          <p style="background:#fff3cd;color:#856404;padding:12px;border-radius:6px">
            ‚ö†Ô∏è You can only review products you have purchased and received.
          </p>
        {% else %}
          <p style="background:#e3f2fd;color:#1976d2;padding:12px;border-radius:6px">
            Please <a href="/login.html" style="color:#1976d2;font-weight:600">login</a> to write a review.
          </p>
        {% endif %}
        
        <!-- Reviews List -->
        {% if ratings %}
          <div class="reviews">
            {% for rating in ratings %}
              <div class="review-card">
                <div class="review-header">
                  <span class="review-user">{{ rating[3] }}</span>
                  <span class="review-date">{{ rating[2][:10] }}</span>
                </div>
                <div class="review-stars">{% for i in range(1, 6) %}{% if i <= rating[0] %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</div>
                {% if rating[1] %}
                  <p class="review-comment">{{ rating[1] }}</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p style="color:#999;text-align:center;padding:20px">No reviews yet. Be the first to review!</p>
        {% endif %}
      </div>
    {% endif %}
  </main>

<script id="product-data" type="application/json">{{ product | tojson | safe }}</script>
<script>
const productData = JSON.parse(document.getElementById('product-data').textContent || 'null');

function addToCart(id){
  try{
    const prod = productData;
    if(!prod){ alert('Product not found'); return; }

    const raw = localStorage.getItem('cart') || '[]';
    const cart = JSON.parse(raw);
    const existing = cart.find(i => String(i.id) === String(prod.id));
    if(existing){ 
      existing.qty = (existing.qty || 1) + 1; 
    }
    else { 
      cart.push(Object.assign({}, prod, { qty: 1 })); 
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    alert(prod.name + ' added to cart');
  }catch(e){
    console.error('addToCart error', e);
    alert('Could not add to cart');
  }
}

// Star rating functionality
const stars = document.querySelectorAll('.star-rating span');
const ratingInput = document.getElementById('ratingValue');

if(stars.length > 0) {
  // Set initial rating
  const initialRating = parseInt(ratingInput.value) || 0;
  updateStars(initialRating);
  
  stars.forEach(star => {
    star.addEventListener('click', function() {
      const value = parseInt(this.dataset.value);
      ratingInput.value = value;
      updateStars(value);
    });
    
    star.addEventListener('mouseover', function() {
      const value = parseInt(this.dataset.value);
      updateStars(value);
    });
  });
  
  document.querySelector('.star-rating').addEventListener('mouseleave', function() {
    const currentValue = parseInt(ratingInput.value) || 0;
    updateStars(currentValue);
  });
}

function updateStars(rating) {
  stars.forEach((star, index) => {
    if(index < rating) {
      star.classList.add('active');
    } else {
      star.classList.remove('active');
    }
  });
}

async function submitRating() {
  const rating = parseInt(ratingInput.value);
  const comment = document.getElementById('commentText').value.trim();
  
  if(!rating || rating < 1 || rating > 5) {
    alert('Please select a star rating');
    return;
  }
  
  try {
    const response = await fetch('/api/submit-rating', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        product_id: productData.id,
        rating: rating,
        comment: comment
      })
    });
    
    const data = await response.json();
    
    if(data.success) {
      alert('Review submitted successfully!');
      location.reload();
    } else {
      alert(data.message || 'Failed to submit review');
    }
  } catch(error) {
    console.error('Error submitting rating:', error);
    alert('Failed to submit review. Please try again.');
  }
}
</script>
</body>
</html>